/*Below SQL code will pull Glucose labs from CDW*/
/*Step 2 will download the saved Glucose lab pull table into SAS dataset for further cleaning*/

use /*INSERT STUDY NAME*/
go

/*pull in all loincsids*/
select LOINC, Component, Sta3n, LOINCSID
into #loinc
from [CDWWork].[Dim].[loinc]
where loinc in ('14743-9', 
'14749-6', 
'1547-9', 
'16165-3', 
'16166-1', 
'16167-9', 
'16168-7', 
'16169-5', 
'16170-3', 
'2339-0', 
'2340-8', 
'2341-6', 
'2345-7', 
'35211-2', 
'39480-9', 
'39481-7', 
'41651-1', 
'41652-9', 
'41653-7', 
'51596-5', 
'5914-7', 
'72516-8', 
'74774-1', 
'77135-2', 
'10449-7', 
'10450-5', 
'10832-4', 
'10833-2', 
'11032-0', 
'11142-7', 
'11143-5', 
'12610-2', 
'12611-0', 
'12614-4', 
'12615-1', 
'12616-9', 
'12617-7', 
'12618-5', 
'12619-3', 
'12620-1', 
'12621-9', 
'12622-7', 
'12623-5', 
'12624-3', 
'12625-0', 
'12626-8', 
'12627-6', 
'12638-3', 
'12639-1', 
'12640-9', 
'12641-7', 
'12642-5', 
'12643-3', 
'12644-1', 
'12645-8', 
'12646-6', 
'12647-4', 
'12648-2', 
'12649-0', 
'12650-8', 
'12651-6', 
'12652-4', 
'12653-2', 
'12654-0', 
'12655-7', 
'12656-5', 
'12657-3', 
'12658-1', 
'12659-9', 
'13606-9', 
'13607-7', 
'13608-5', 
'13609-3', 
'13865-1', 
'13866-9', 
'14137-4', 
'14751-2', 
'14752-0', 
'14753-8', 
'14754-6', 
'14755-3', 
'14756-1', 
'14757-9', 
'14758-7', 
'14759-5', 
'14760-3', 
'14761-1', 
'14762-9', 
'14763-7', 
'14764-5', 
'14765-2', 
'14766-0', 
'14767-8', 
'14768-6', 
'14769-4', 
'14770-2', 
'14771-0', 
'1492-8', 
'1493-6', 
'1494-4', 
'1496-9', 
'1497-7', 
'1498-5', 
'1499-3', 
'14995-5', 
'14996-3', 
'1500-8', 
'1501-6', 
'1504-0', 
'1506-5', 
'1507-3', 
'15074-8', 
'1510-7', 
'1512-3', 
'1513-1', 
'1514-9', 
'1517-2', 
'1518-0', 
'1521-4', 
'1522-2', 
'1523-0', 
'1524-8', 
'1525-5', 
'1526-3', 
'1527-1', 
'1528-9', 
'1530-5', 
'1533-9', 
'1534-7', 
'1535-4', 
'1536-2', 
'1537-0', 
'1539-6', 
'1540-4', 
'1542-0', 
'1543-8', 
'1544-6', 
'1548-7', 
'1549-5', 
'1550-3', 
'1551-1', 
'1552-9', 
'1553-7', 
'1554-5', 
'1556-0', 
'1557-8', 
'1558-6', 
'16914-4', 
'16915-1', 
'17865-7', 
'18296-4', 
'18342-6', 
'18353-3', 
'18354-1', 
'19104-9', 
'19105-6', 
'20436-2', 
'20437-0', 
'20438-8', 
'20439-6', 
'20440-4', 
'20441-2', 
'21308-2', 
'21309-0', 
'21310-8', 
'25663-6', 
'25665-1', 
'25666-9', 
'25668-5', 
'25669-3', 
'25671-9', 
'25672-7', 
'25673-5', 
'25674-3', 
'25676-8', 
'25677-6', 
'25679-2', 
'25680-0', 
'26539-7', 
'26541-3', 
'26543-9', 
'26544-7', 
'26554-6', 
'26555-3', 
'26695-7', 
'26777-3', 
'26778-1', 
'26779-9', 
'26780-7', 
'26781-5', 
'26782-3', 
'26783-1', 
'26817-7', 
'26853-2', 
'26854-0', 
'27432-4', 
'29329-0', 
'29330-8', 
'29331-6', 
'29332-4', 
'29412-4', 
'30251-3', 
'30252-1', 
'30253-9', 
'30263-8', 
'30264-6', 
'30265-3', 
'30266-1', 
'30267-9', 
'30344-6', 
'30345-3', 
'30346-1', 
'32016-8', 
'32319-6', 
'32320-4', 
'32321-2', 
'32322-0', 
'32359-2', 
'32820-3', 
'33024-1', 
'34056-2', 
'34057-0', 
'34058-8', 
'34059-6', 
'34060-4', 
'35184-1', 
'39561-6', 
'39562-4', 
'39563-2', 
'39997-2', 
'39998-0', 
'39999-8', 
'40000-2', 
'40001-0', 
'40002-8', 
'40003-6', 
'40004-4', 
'40005-1', 
'40006-9', 
'40007-7', 
'40008-5', 
'40009-3', 
'40010-1', 
'40011-9', 
'40012-7', 
'40013-5', 
'40014-3', 
'40015-0', 
'40016-8', 
'40017-6', 
'40018-4', 
'40019-2', 
'40020-0', 
'40021-8', 
'40022-6', 
'40023-4', 
'40024-2', 
'40025-9', 
'40026-7', 
'40027-5', 
'40028-3', 
'40029-1', 
'40030-9', 
'40031-7', 
'40032-5', 
'40033-3', 
'40034-1', 
'40035-8', 
'40036-6', 
'40037-4', 
'40038-2', 
'40039-0', 
'40040-8', 
'40041-6', 
'40042-4', 
'40043-2', 
'40044-0', 
'40045-7', 
'40148-9', 
'40149-7', 
'40150-5', 
'40151-3', 
'40152-1', 
'40153-9', 
'40154-7', 
'40155-4', 
'40156-2', 
'40157-0', 
'40158-8', 
'40159-6', 
'40160-4', 
'40161-2', 
'40162-0', 
'40163-8', 
'40164-6', 
'40165-3', 
'40166-1', 
'40167-9', 
'40168-7', 
'40169-5', 
'40170-3', 
'40171-1', 
'40172-9', 
'40173-7', 
'40174-5', 
'40175-2', 
'40176-0', 
'40177-8', 
'40178-6', 
'40179-4', 
'40180-2', 
'40181-0', 
'40182-8', 
'40183-6', 
'40184-4', 
'40185-1', 
'40186-9', 
'40187-7', 
'40188-5', 
'40189-3', 
'40190-1', 
'40191-9', 
'40192-7', 
'40193-5', 
'40194-3', 
'40195-0', 
'40196-8', 
'40197-6', 
'40198-4', 
'40199-2', 
'40200-8', 
'40201-6', 
'40202-4', 
'40203-2', 
'40204-0', 
'40205-7', 
'40206-5', 
'40207-3', 
'40208-1', 
'40209-9', 
'40210-7', 
'40211-5', 
'40212-3', 
'40213-1', 
'40214-9', 
'40215-6', 
'40216-4', 
'40217-2', 
'40218-0', 
'40219-8', 
'40220-6', 
'40221-4', 
'40222-2', 
'40259-4', 
'40260-2', 
'40261-0', 
'40262-8', 
'40263-6', 
'40276-8', 
'40277-6', 
'40278-4', 
'40279-2', 
'40280-0', 
'40285-9', 
'40286-7', 
'40287-5', 
'40318-8', 
'40319-6', 
'40320-4', 
'40321-2', 
'40322-0', 
'40323-8', 
'40324-6', 
'40858-3', 
'41024-1', 
'41604-0', 
'44919-9', 
'45052-8', 
'45053-6', 
'45054-4', 
'45055-1', 
'45056-9', 
'45298-7', 
'45299-5', 
'47622-6', 
'47859-4', 
'48109-3', 
'48605-0', 
'48606-8', 
'48607-6', 
'48810-6', 
'48983-1', 
'48984-9', 
'48985-6', 
'48986-4', 
'48988-0', 
'48989-8', 
'48990-6', 
'48992-2', 
'48993-0', 
'48994-8', 
'49134-0', 
'50206-2', 
'50207-0', 
'50208-8', 
'50212-0', 
'50213-8', 
'50214-6', 
'50215-3', 
'50216-1', 
'50217-9', 
'50218-7', 
'50586-7', 
'50587-5', 
'50588-3', 
'50589-1', 
'50608-9', 
'50667-5', 
'50751-7', 
'51426-5', 
'51597-3', 
'51766-4', 
'51767-2', 
'51768-0', 
'51769-8', 
'53049-3', 
'53093-1', 
'53094-9', 
'53474-3', 
'53475-0', 
'53476-8', 
'53480-0', 
'53481-8', 
'53482-6', 
'53483-4', 
'53484-2', 
'53485-9', 
'53486-7', 
'53487-5', 
'53928-8', 
'53929-6', 
'54248-0', 
'54249-8', 
'54250-6', 
'54251-4', 
'54252-2', 
'54253-0', 
'54254-8', 
'54255-5', 
'54256-3', 
'54257-1', 
'54258-9', 
'54259-7', 
'54260-5', 
'54261-3', 
'54262-1', 
'54263-9', 
'54264-7', 
'54265-4', 
'54266-2', 
'54267-0', 
'54268-8', 
'54269-6', 
'54270-4', 
'54271-2', 
'54272-0', 
'54273-8', 
'54274-6', 
'54275-3', 
'54276-1', 
'54277-9', 
'54392-6', 
'54393-4', 
'54394-2', 
'54395-9', 
'54396-7', 
'54397-5', 
'54398-3', 
'54399-1', 
'54400-7', 
'54401-5', 
'54495-7', 
'54496-5', 
'54497-3', 
'54498-1', 
'54499-9', 
'55351-1', 
'55352-9', 
'55381-8', 
'56751-1', 
'57350-1', 
'57971-4', 
'57972-2', 
'59157-8', 
'59791-4', 
'59792-2', 
'59793-0', 
'59794-8', 
'59795-5', 
'59796-3', 
'59797-1', 
'59812-8', 
'59813-6', 
'59814-4', 
'59815-1', 
'6689-4', 
'6749-6', 
'6752-0', 
'6756-1', 
'6760-3', 
'6762-9', 
'69941-3', 
'69942-1', 
'69943-9', 
'69944-7', 
'70208-4', 
'72895-6', 
'72896-4', 
'74084-5', 
'75405-1', 
'75637-9', 
'76629-5', 
'77145-1', 
'77677-3', 
'77681-5', 
'79193-9', 
'79194-7', 
'79195-4', 
'79196-2', 
'80959-0', 
'87421-4', 
'87422-2', 
'9375-7', 
'9376-5', 
'9377-3', 
'9378-1', 
'48991-4')

/*pull in Labchemtest*/
SELECT Labchemtestsid, LabChemTestName, LabChemPrintTestName, Sta3n
into #labtestnames
FROM  [CDWWork].[Dim].[LabChemTest]
WHERE labchemtestname in ('GLUCOSE', 
'POC GLUCOSE', 
'FINGERSTICK GLUCOSE', 
'WHOLE BLOOD GLUCOSE', 
'FINGER STICK GLUCOSE', 
'ANCILLARY GLUCOSE', 
'ANCILLARY GLUCOSE (NEW)', 
'ACC-GLUCOSE', 
'GLUCOSE POC', 
'FINGERSTICK GLUCOSE (V2)', 
'GLUCOMETER GLUCOSE', 
'GLUCOSE FINGER STICK', 
'AT GLUCOSE', 
'ANCILLARY GLUCOSE-ABBOTT', 
'GLUCOMETER-GLUCOSE (WB)', 
'GLUCOSE (V2)', 
'GLUCOSE,POC', 
'FS GLUCOSE', 
'GLUCOSE, FINGER-STICK', 
'CBG GLUCOSE', 
'GLUCOSE_ANC', 
'GLUCOSE-POC', 
'GLUCOSE,BLOOD-poct  (STL)', 
'CBG', 
'GLUCOSE*', 
'CAPILLARY BLOOD GLUCOSE', 
'GLUCOSE-AT', 
'GLUCOMETER', 
'POC-GLUCOSE', 
'POC-GLUCOSE (METER)', 
'GLUCOSE (RALS)', 
'GLUCOSE, ANC', 
'GLUCOSE (POC)', 
'GLUCOSE-------------O', 
'Glucose', 
'GLUCOMETER (STRIP)', 
'ANC GLUCOSE POC', 
'WB7 GLUCOSE(MEM)', 
'GLUCOSE(FINGERSTICK)-METER', 
'GLUCOSE*IA', 
'GLUCOSE (FINGER-STICK)', 
'AT- GLUCOSE PCX', 
'GLUCOSE,WHOLE BLOOD FINGERSTICK', 
'WB GLUCOSE(MOU)', 
'AT GLUCOSE (ANCILLARY)', 
'GLUCOSE,RANDOM', 
'POC - WHOLE BLOOD GLUCOSE', 
'ATS GLUCOSE,FINGERSTICK', 
'POCGLUCOSE', 
'GLUCOSE-HAND MONITOR', 
'GLUCOSE (CAPILLARY WHOLE BLD)', 
'FINGERSTICK GLUC (PXP)', 
'POINT-OF CARE GLUCOSE', 
'METER GLUCOSE', 
'GLUCOSE*NE', 
'GLUCOSE-FINGER STICK*CI', 
'POC GLUCOSEMETER GLUCOSE', 
'GLUCOSE (FINGERSTICK)', 
'ACCU-CHEK', 
'GLUCOSE,SERUM', 
'WB GLUCOSE*NE', 
'PCX GLUCOSE', 
'GLUCOSE (FV)', 
'AT-GLUCOSE', 
'GLUCOSE,Blood', 
'GLUCOSE,ANCILLARY', 
'WHOLE BLOOD GLUCOSE, POC', 
'GLUCOSE (METER)', 
'WBGLUCOSE', 
'GLUCOSE (DCed 2.1.15', 
'GLUCOSE-FINGERSTICK', 
'GLUCOSE POINT OF CARE', 
'GLUC.', 
'GLUCOSE, ANCILLARY*ic', 
'ANC-GLU', 
'S/S GLUCOSE', 
'ZGLUCOSE', 
'BEDSIDE GLUCOSE', 
'GLUCOSE(ANC)', 
'WB GLUCOSE', 
'FINGERSTICK GLUCOSE  (MA)', 
'METER Glucose', 
'ACCUCHEK GLUCOSE', 
'GLUCOSE(D/C 6/7/17)', 
'GLUCOSE, ANCILLARY', 
'GLUCOSE (POCT), WB', 
'GLUCOSE, FINGERSTICK', 
'GLUCOSE, SERUM', 
'GLUCOSE -SERUM THRU 3/31/18', 
'FINGER STICK GLUCOSE POC', 
'CAPILLARY BLOOD SUGAR', 
'GLUCOSE (RANDOM)', 
'CAPILLARY GLUCOSE', 
'GLUCOSE BY METER', 
'GAS-GLUCOSE(SICU)', 
'GLUCOSE(DCd 2.17.15)', 
'GLUCOSE(blood/plasma)', 
'GEM-glucose', 
'I-STAT GLUC', 
'ANCILLARY GLUCOSE-PB', 
'GLUCOSE, PLASMA', 
'GLUCOSE METER GLUCOSE', 
'GLUCOSE, Fingerstick', 
'AccuChek (Glucose)', 
'iGLUCOSE (new)', 
'iGLUCOSE', 
'GLUCOSE (B-GAS)', 
'GLUCOSE-WB (R)', 
'Glucose..', 
'GLUCOSE (Arterial)', 
'POCT GLUCOSE', 
'POC-GLUCOSE (GLU)', 
'FASTING GLUCOSE', 
'GLUCOSE(BMT)', 
'GLUCOSE-GAS', 
'GLUCOSE(LUF)', 
'GLUCOSE (WHOLE BLOOD)', 
'GLUCOSE (FS)', 
'iSTAT GLUCOSE', 
'BG GLUCOSE', 
'GLUCOSE (FAST)', 
'ISTAT GLUCOSE', 
'GLUCOSE(BG)', 
'GLUCOSE (BLOOD)', 
'POC GLUCOSE ISTAT', 
'POC-Glucose', 
'ZZZGlucose.', 
'GLUCOSE_KTY', 
'AT- GLUCOSE', 
'GLUC---POC', 
'GLU-POC', 
'Glucose-iSTAT', 
'GLUCOSE, FASTING', 
'GLUCOSE (FASTING)', 
'GLUCOSE(TMB)', 
'GLUCOSE (BST)', 
'GAS-GLUCOSE', 
'GLUCOSE (RAPIDLAB)', 
'ANCILLARY GLUCOSE (CHEM8)', 
'GLUCOSE (MV)*INACT(1-1-15)', 
'GLUCOSE (Venous)', 
'ABG,GLUCOSE', 
'P-GLUCOSE(I)', 
'GLUCOSE (GLUCOMETER)', 
'GLUCOSE (ISTAT)', 
'CVICU-GLUCOSE', 
'I-STAT, GLU (STL-MA)', 
'Glucose-i', 
'D-GLUCOSE', 
'GLUCOSE-POC*ic', 
'GLUCOSE (iSTAT)', 
'GLUCOSE (O.R.)', 
'I-STAT GLUCOSE', 
'Glu', 
'ATS GLUCOSE (GAS)', 
'MN GLUCOSE', 
'CI-GLUCOSE', 
'GLUCOSE,COBAS', 
'GLUCOSE {i-STAT} - Arterial', 
'PB GLUCOSE', 
'GLUCOSE (ABL)', 
'GLUCOSE-ARTERIAL BLOOD', 
'W-GLUCOSE', 
'Anc Glucose', 
'POC-GLUCOSE OR', 
'POC GLUC', 
'.GLU (istat)', 
'_GLUC (OF ABG PANEL)', 
'I-GLUCOSE', 
'POC-ISTAT G GLU', 
'FASTING GTT', 
'2 HR PP GLUCOSE', 
'GLUCOSE,FASTING', 
'Glucose, Fasting', 
'_POC GLU', 
'HBPC GLUCOSE', 
'GLUCOSE (LAB)', 
'BR-GLUCOSE', 
'GLUCOSE (DIALYSIS ONLY)', 
'GLUCOSE (POC-BMP)', 
'GLUCOSE-CRITICAL ILL (WB-SPECIAL TUBE)', 
'2Hr.GTT', 
'WBG MONITOR', 
'Aviva GLUCOMETER', 
'GLUCOSE, FASTING (Serum)', 
'FBS', 
'Glucose (ATS)', 
'NUCMED GLUCOSE', 
'_GLUCOSE (I-STAT)', 
'STAT GLUCOSE', 
'ELD GLUCOSE', 
'GLUCOSE(ISTAT POC)', 
'HOME GLUCOSE METER', 
'2HR GTT', 
'MMC GLUCOSE', 
'POC GLU', 
'1HR GTT', 
'GLUCOSE (WORC)', 
'1Hr.GTT', 
'GLUCOSE-ISTAT POC', 
'GLUCOSE,SERUM(LABCORP)', 
'1/2HR GTT', 
'GLUCOSE BY METER(MC)', 
'GLUCOSE POC (BU/BH)', 
'1/2Hr.GTT', 
'LRL GLUCOSE', 
'GLUCOSE, WHOLE BLOOD (POC)', 
'GLUCOSE,iSTAT', 
'SALEM GLUCOSE-PB', 
'3Hr.GTT', 
'Advantage GLUCOMETER', 
'GLUCOSE-CC', 
'zzglucose(DO NOT USE)', 
'FASTING BLOOD SUGAR', 
'FASTING GLUCOSE, PLASMA', 
'CL ABG (STL)', 
'GLUCOSE, 0-HOUR', 
'GLUCOSE (GLUCOMETER)', 
'HATT-GLUCOSE', 
'GLUCOSE, 2HR P. LOAD', 
'GLUCOSE (Ref.Lab)', 
'GLUCOSE,ARTERIAL', 
'SICU GLUCOSE', 
'GLUCOSE-CRITICAL (WB-SPECIAL TUBE)', 
'GLUCOSE (HR)', 
'2 Hr. GTT', 
'FASTING GLUCOSE (GTT)', 
'1 Hr. GTT', 
'MH GLUCOSE', 
'GLUCOSE, RANDOM', 
'GLUCOSE (BLOOD GAS)', 
'FAST LTT', 
'LEG GLUCOSE', 
'_ZY 0 HR (OF GLUC TOL)', 
'2HR POSTLOAD GLUCOSE (GTT)', 
'GLUCOSE, FASTING (Plasma)', 
'2 hr GLUCOSE', 
'GLUCOSE,SERUM-Q', 
'FASTING GTT*ia', 
'1/2HR LTT', 
'GLUCOSE (FLUID)(DC"D 3/10/17)', 
'1HR LTT', 
'_ZY 2 HR (OF GLUC TOL)', 
'2HR LTT', 
'2Hr. GTT*ia', 
'[ .FASTING GTT', 
'Glucose (I-Stat Chem8+)', 
'WBGLUCOSE-RC', 
'[ .2HR GTT', 
'FASTING GLUCOSE (GTT/LTT)', 
'2HR POST GLUCOSE LOAD', 
'GLUCOSE-CRITICALLY ILL', 
'GLUCOSE (Fasting)', 
'GLUCOSE (PRE 75g)', 
'GLUCOSE-iSTAT', 
'FASTING SERUM GLUC.', 
'3HR GTT', 
'2HR SERUM GLUCOSE', 
'2hr. OGTT (ADA)', 
'GLUCOSE TOLERANCE TEST (FASTING LEVEL)')


/*pull loincsids and labchemtestsids from CDW for 2014-2017*/
SELECT a.LabChemSID, a.LabSubjectSID,  a.Sta3n, a.LabPanelIEN, a.LabPanelSID, a.LongAccessionNumberUID, a.ShortAccessionNumber,
       a.LabChemTestSID, a.PatientSID, a.LabChemSpecimenDateTime, a.LabChemSpecimenDateSID, a.LabChemCompleteDateTime, a.LabChemCompleteDateSID,
       a.LabChemResultValue, a.LabChemResultNumericValue, a.TopographySID, a.LOINCSID, a.Units, a.RefHigh, a.RefLow, d.Topography
into #Glucose2014_2017
FROM  src.Chem_PatientLabChem AS A
INNER JOIN #loinc b on  a.Loincsid=b.Loincsid 
LEFT JOIN [CDWWork].[Dim].[topography] AS d ON A.TopographySID =D.TopographySID
	WHERE a.LabChemSpecimenDateTime >= '2014-01-01' and a.LabChemSpecimenDateTime < '2018-01-01'

UNION

SELECT a.LabChemSID, a.LabSubjectSID,  a.Sta3n, a.LabPanelIEN, a.LabPanelSID, a.LongAccessionNumberUID, a.ShortAccessionNumber,
       a.LabChemTestSID, a.PatientSID, a.LabChemSpecimenDateTime, a.LabChemSpecimenDateSID, a.LabChemCompleteDateTime, a.LabChemCompleteDateSID,
       a.LabChemResultValue, a.LabChemResultNumericValue, a.TopographySID, a.LOINCSID, a.Units, a.RefHigh, a.RefLow, d.Topography
FROM src.Chem_PatientLabChem a         
INNER JOIN #labtestnames b ON a.labchemtestsid=b.labchemtestsid 
LEFT JOIN [CDWWork].[Dim].[topography] AS d ON A.TopographySID =D.TopographySID
     WHERE loincsid=-1 and     
      a.LabChemSpecimenDateTime >= '2014-01-01' and a.LabChemSpecimenDateTime < '2018-01-01'


/*get unique PatientICN*/
select a.*, b.PatientICN
into dflt.Glucose2014_2017
from #Glucose2014_2017 a
left join src.CohortCrosswalk b on a.patientsid=b.PatientSID

--download dflt talbe into a SAS table to do further data management